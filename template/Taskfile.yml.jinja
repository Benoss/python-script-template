version: '3'

tasks:
  setup:
    desc: Setup environment and block pip usage
    cmds:
      - uv sync --extra dev
      - |
        cat <<'EOF' > .venv/bin/pip
        #!/bin/bash
        echo "Error: Standard 'pip' usage is prohibited in this project."
        echo "Please use 'uv add <package>', 'uv remove <package>', or 'uv sync' instead."
        exit 1
        EOF
      - cp .venv/bin/pip .venv/bin/pip3
      - chmod +x .venv/bin/pip
      - chmod +x .venv/bin/pip3
      - |
        cat <<'EOF' > .venv/pip.conf
        [global]
        # This makes pip look for a non-existent index, effectively breaking installs
        index-url = http://localhost:0/null
        # Require virtualenv to prevent global installs
        require-virtualenv = true
        EOF

  init:
    desc: Initialize a new project with git and dependencies
    cmds:
      - git init
      - task: setup
      - git add .
      - git commit -m "Initial commit"

  install:
    desc: Install all dependencies including dev dependencies
    cmds:
      - uv sync --extra dev

  lint:
    desc: Run all linting and formatting tools
    cmds:
      - uv run ruff check --fix .
      - uv run ruff format .
      - uv run ty check .

  dev:
    desc: Run one-shot linting (same as lint task)
    cmds:
      - task: lint

  dev-watch:
    desc: Run linting in watch mode (continuous)
    cmds:
      - uv run ruff check --watch .

  test:
    desc: Run all tests with pytest
    cmds:
      - uv run pytest

  test-watch:
    desc: Run tests in watch mode (requires pytest-xdist)
    cmds:
      - uv run pytest --looponfail

  test-cov:
    desc: Run tests with coverage report
    cmds:
      - uv run pytest --cov=. --cov-report=term-missing --cov-report=html
{% if project_type == "script" %}
  run:
    desc: Run the main script
    cmds:
      - uv run python main_{{ project_slug_underscore }}.py
{% elif project_type == "django" %}
  runserver:
    desc: Start Django development server
    cmds:
      - uv run python manage.py runserver

  migrate:
    desc: Apply database migrations
    cmds:
      - uv run python manage.py migrate

  makemigrations:
    desc: Create new database migrations
    cmds:
      - uv run python manage.py makemigrations

  shell:
    desc: Start Django shell
    cmds:
      - uv run python manage.py shell

  createsuperuser:
    desc: Create Django superuser
    cmds:
      - uv run python manage.py createsuperuser

  init-data:
    desc: Initialize database with seed data
    cmds:
      - uv run python manage.py init_data

  db-up:
    desc: Start PostgreSQL database in Podman
    cmds:
      - podman-compose up -d

  db-down:
    desc: Stop PostgreSQL database
    cmds:
      - podman-compose down

  db-logs:
    desc: View database logs
    cmds:
      - podman-compose logs -f db

  tailwind-watch:
    desc: Watch and compile Tailwind CSS for development
    cmds:
      - bunx @tailwindcss/cli@latest -i ./static/css/input.css -o ./static/css/output.css --watch

  tailwind-build:
    desc: Build Tailwind CSS for production
    cmds:
      - bunx @tailwindcss/cli@latest -i ./static/css/input.css -o ./static/css/output.css --minify
{% endif %}
