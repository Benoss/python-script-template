version: '3'

tasks:
  setup:
    desc: Setup environment and block pip usage
    cmds:
      - uv sync --extra dev
      - |
        cat <<'EOF' > .venv/bin/pip
        #!/bin/bash
        echo "Error: Standard 'pip' usage is prohibited in this project."
        echo "Please use 'uv add <package>', 'uv remove <package>', or 'uv sync' instead."
        exit 1
        EOF
      - cp .venv/bin/pip .venv/bin/pip3
      - chmod +x .venv/bin/pip
      - chmod +x .venv/bin/pip3
      - |
        cat <<'EOF' > .venv/pip.conf
        [global]
        # This makes pip look for a non-existent index, effectively breaking installs
        index-url = http://localhost:0/null
        # Require virtualenv to prevent global installs
        require-virtualenv = true
        EOF

  init:
    desc: Initialize a new project with git and dependencies
    cmds:
      - git init
      - task: setup
      - git add .
      - git commit -m "Initial commit"

  install:
    desc: Install all dependencies including dev dependencies
    cmds:
      - uv sync --extra dev

  lint:
    desc: Run all linting and formatting tools
    cmds:
      - uv run ruff check --fix .
      - uv run ruff format .
      - uv run ty check .

  dev:
    desc: Run one-shot linting (same as lint task)
    cmds:
      - task: lint

  dev-watch:
    desc: Run linting in watch mode (continuous)
    cmds:
      - uv run ruff check --watch .

  test:
    desc: Run all tests with pytest
    cmds:
      - uv run pytest

  test-watch:
    desc: Run tests in watch mode (requires pytest-xdist)
    cmds:
      - uv run pytest --looponfail

  test-cov:
    desc: Run tests with coverage report
    cmds:
      - uv run pytest --cov=. --cov-report=term-missing --cov-report=html
{% if project_type == "script" %}
  run:
    desc: Run the main script
    cmds:
      - uv run python main_{{ project_slug_underscore }}.py
{% elif project_type == "django" %}
  runserver:
    desc: Start Django development server
    cmds:
      - uv run python manage.py runserver

  migrate:
    desc: Apply database migrations
    cmds:
      - uv run python manage.py migrate

  makemigrations:
    desc: Create new database migrations
    cmds:
      - uv run python manage.py makemigrations

  shell:
    desc: Start Django shell
    cmds:
      - uv run python manage.py shell

  createsuperuser:
    desc: Create Django superuser
    cmds:
      - uv run python manage.py createsuperuser

  init-data:
    desc: Initialize database with seed data
    cmds:
      - uv run python manage.py init_data

  db-up:
    desc: Start PostgreSQL database in Podman
    cmds:
      - mkdir -p podman_data/postgresql
      - |
        podman run -d \
          --name {{ project_slug_underscore }}_db \
          --replace \
          -e POSTGRES_DB={{ project_slug_underscore }}_db \
          -e POSTGRES_USER={{ project_slug_underscore }}_user \
          -e POSTGRES_PASSWORD={{ project_slug_underscore }}_password \
          -p 5432:5432 \
          -v "$(pwd)/podman_data/postgresql:/var/lib/postgresql/data:Z" \
          docker.io/library/postgres:16-alpine
      - echo "Waiting for PostgreSQL to be ready..."
      - |
        until podman exec {{ project_slug_underscore }}_db pg_isready -U {{ project_slug_underscore }}_user -d {{ project_slug_underscore }}_db > /dev/null 2>&1; do
          sleep 1
        done
      - echo "PostgreSQL is ready!"

  db-down:
    desc: Stop PostgreSQL database
    cmds:
      - podman stop {{ project_slug_underscore }}_db || true
      - podman rm {{ project_slug_underscore }}_db || true

  db-logs:
    desc: View database logs
    cmds:
      - podman logs -f {{ project_slug_underscore }}_db

  tailwind-watch:
    desc: Watch and compile Tailwind CSS for development
    cmds:
      - |
        # Install dev dependencies with bun before running Tailwind; fail if bun is missing
        if [ -f package.json ]; then
          if command -v bun >/dev/null 2>&1; then
            bun install || { echo "bun install failed" >&2; exit 1; }
          else
            echo "Error: 'bun' is required to run Tailwind tasks. Install from https://bun.sh" >&2
            exit 1
          fi
        fi
        bunx @tailwindcss/cli@latest -i ./static/css/input.css -o ./static/css/output.css --watch

  tailwind-build:
    desc: Build Tailwind CSS for production
    cmds:
      - |
        # Install dev dependencies with bun before running Tailwind; fail if bun is missing
        if [ -f package.json ]; then
          if command -v bun >/dev/null 2>&1; then
            bun install || { echo "bun install failed" >&2; exit 1; }
          else
            echo "Error: 'bun' is required to run Tailwind tasks. Install from https://bun.sh" >&2
            exit 1
          fi
        fi
        bunx @tailwindcss/cli@latest -i ./static/css/input.css -o ./static/css/output.css --minify
{% endif %}
